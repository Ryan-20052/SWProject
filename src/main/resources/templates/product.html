<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.name}">Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link rel="stylesheet" th:href="@{/product.css}">
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Lu√¥n khai b√°o bi·∫øn sessionCustomerId an to√†n ƒë·ªÉ JS c√≥ th·ªÉ d√πng -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const sessionCustomerId = /*[[${session.customer != null ? session.customer.id : 'null'}]]*/ 'null';
        const productName = /*[[${product.name}]]*/ 'S·∫£n ph·∫©m';
        /*]]>*/
    </script>

    <style>
        /* --- t·ªëi gi·∫£n style cho ph·∫ßn mua h√†ng --- */
        .alert { margin: 10px 0; padding: 12px; border-radius: 6px; font-weight: bold; }
        .alert-success { background-color: #e6ffed; color: #0f5132; border: 1px solid #badbcc; }
        .alert-warning { background-color: #fff3cd; color: #664d03; border: 1px solid #ffeeba; }
        .alert-error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

        .purchase-section { margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .amount-wrapper { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
        .amount-wrapper input { width:80px; padding:6px; font-size:16px; text-align:center; border:1px solid #ccc; border-radius:6px; }
        .action-buttons { display:flex; gap:12px; }
        button.cart, button.buy-now { flex:1; padding:10px 14px; font-size:15px; border:none; border-radius:6px; cursor:pointer; color:white; }
        button.cart { background:#007bff; } button.cart:hover{background:#0069d9;}
        button.buy-now{ background:#28a745; } button.buy-now:hover{background:#218838;}
        button:disabled { opacity:0.6; cursor:not-allowed; }
        .variant-option { display:block; margin:6px 0; }
    </style>
</head>
<body>
<header id="siteHeader">
    <div class="header-inner">
        <h1>License Shop</h1>
        <div class="actions" id="actions">
            <div th:if="${session.customer == null}">
                <button onclick="window.location.href='/login.html'">ƒêƒÉng nh·∫≠p</button>
                <button onclick="window.location.href='/register.html'">ƒêƒÉng k√Ω</button>
            </div>
            <div th:if="${session.customer != null}">
                <button onclick="window.location.href='/cart/view'">Gi·ªè h√†ng</button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <div class="product-header">
        <div class="thumb" th:style="|background-image: url('${product.img_url}')|"></div>
        <div class="info">
            <h1 th:text="${product.name}">T√™n s·∫£n ph·∫©m</h1>

            <div th:if="${message != null}">
                <div th:if="${#strings.contains(message, 'th√†nh c√¥ng')}" class="alert alert-success" th:text="${message}"></div>
                <div th:if="${#strings.contains(message, 'Vui l√≤ng ƒëƒÉng nh·∫≠p')}" class="alert alert-warning" th:text="${message}"></div>
                <div th:if="${!(#strings.contains(message, 'th√†nh c√¥ng') or #strings.contains(message, 'Vui l√≤ng ƒëƒÉng nh·∫≠p'))}" class="alert alert-error" th:text="${message}"></div>
            </div>

            <div class="price"
                 th:text="${selectedVariant != null ? selectedVariant.price + ' ƒë' :
                          (variants != null and #lists.isEmpty(variants) == false ? variants[0].price + ' ƒë' : 'Li√™n h·ªá')}">
                Gi√°
            </div>

            <section class="product-description">
                <h2>M√¥ t·∫£ s·∫£n ph·∫©m</h2>
                <p th:text="${product.description}">M√¥ t·∫£ s·∫£n ph·∫©m</p>
            </section>

            <!-- LIST VARIANTS -->
            <div class="variants">
                <h3>Ch·ªçn g√≥i/phi√™n b·∫£n:</h3>
                <form id="variantSelectForm" method="get" th:action="@{/product/{id}(id=${product.id})}">
                    <div class="options">
                        <!-- Duy·ªát variants, ch·ªâ show c√°c duration mong mu·ªën nh∆∞ tr∆∞·ªõc -->
                        <label class="variant-option" th:each="v : ${variants}">
                            <input type="radio" name="variantId"
                                   th:value="${v.id}"
                                   th:checked="${selectedVariant != null and selectedVariant.id == v.id}" />
                            <span><span th:text="${v.duration}">Th·ªùi h·∫°n</span> - <span th:text="${v.price + ' ƒë'}">Gi√°</span></span>
                        </label>
                    </div>
                    <!-- N√∫t reload (gi·ªØ nguy√™n behaviour n·∫øu b·∫°n mu·ªën reload khi ƒë·ªïi) -->
                    <noscript>
                        <button type="submit">Ch·ªçn</button>
                    </noscript>
                </form>
            </div>

            <!-- PH·∫¶N MUA H√ÄNG (H·ª£p nh·∫•t) -->
            <div class="purchase-section">
                <!-- Form ch√≠nh g·ª≠i POST /cart/add -->
                <form th:action="@{/cart/add}" method="post" id="cartForm">
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <!-- Hidden variantId: gi√° tr·ªã ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng Thymeleaf (selectedVariant) ho·∫∑c JS t·ª´ radio -->
                    <input type="hidden" id="variantIdInput" name="variantId"
                           th:value="${selectedVariant != null ? selectedVariant.id : (variants != null and #lists.isEmpty(variants) == false ? variants[0].id : '')}" />

                    <div class="amount-wrapper">
                        <label for="amountInput">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="amountInput" name="amount" value="1" min="1" />
                        <span th:if="${param.message}" th:text="${param.message}" style="margin-left:10px;color:red;font-weight:bold;"></span>
                    </div>

                    <div class="action-buttons">
                        <!-- Th√™m v√†o gi·ªè (form submit truy·ªÅn variantId, amount, CSRF) -->
                        <button type="submit" class="cart" id="addToCartBtn"
                                th:attr="disabled=${selectedVariant == null and (variants == null or #lists.isEmpty(variants))}">
                            üõí Th√™m v√†o gi·ªè
                        </button>

                        <!-- Mua ngay: g·ªçi API thanh to√°n (JS fetch) -->
                        <button type="button" class="buy-now" id="buyNowBtn"
                                th:attr="disabled=${selectedVariant == null and (variants == null or #lists.isEmpty(variants))}">
                            ‚ö° Mua ngay
                        </button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- SCRIPT: ƒë·ªìng b·ªô variant selection, x·ª≠ l√Ω buy-now v·ªõi CSRF -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // bi·∫øn sessionCustomerId v√† productName ƒë√£ ƒë∆∞·ª£c in ·ªü head
        const buyNowBtn = document.getElementById('buyNowBtn');
        const variantRadios = document.querySelectorAll("input[name='variantId']");
        const variantIdInput = document.getElementById('variantIdInput');
        const addToCartBtn = document.getElementById('addToCartBtn');

        // Helper: c·∫≠p nh·∫≠t hidden input variantId t·ª´ radio ƒë∆∞·ª£c ch·ªçn (n·∫øu c√≥)
        function syncVariantFromRadio() {
            const checked = Array.from(variantRadios).find(r => r.checked);
            if (checked) {
                variantIdInput.value = checked.value;
                // enable buttons n·∫øu c√≥ variant
                buyNowBtn.disabled = false;
                addToCartBtn.disabled = false;
            } else {
                // n·∫øu kh√¥ng c√≥ radio checked, gi·ªØ value ban ƒë·∫ßu (do Thymeleaf set)
                // disable n·∫øu kh√¥ng c√≥ variantId
                if (!variantIdInput.value) {
                    buyNowBtn.disabled = true;
                    addToCartBtn.disabled = true;
                }
            }
        }

        // Khi user click radio: c·∫≠p nh·∫≠t ngay hidden input
        variantRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                syncVariantFromRadio();
                // n·∫øu b·∫°n mu·ªën reload page khi ƒë·ªïi variant theo phi√™n b·∫£n tr∆∞·ªõc, b·ªè comment d√≤ng d∆∞·ªõi:
                // this.form?.submit();
            });
        });

        // Kh·ªüi t·∫°o tr·∫°ng th√°i n√∫t
        syncVariantFromRadio();

        // X·ª≠ l√Ω mua ngay
        buyNowBtn?.addEventListener('click', async function () {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            if (!sessionCustomerId || sessionCustomerId === 'null') {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua s·∫£n ph·∫©m!');
                window.location.href = '/login.html';
                return;
            }

            // L·∫•y variant & amount
            const variantId = variantIdInput.value;
            const amountEl = document.getElementById('amountInput');
            const quantity = amountEl && parseInt(amountEl.value || '1', 10) > 0 ? parseInt(amountEl.value || '1', 10) : 1;

            if (!variantId) {
                alert('Vui l√≤ng ch·ªçn g√≥i s·∫£n ph·∫©m tr∆∞·ªõc khi mua!');
                return;
            }

            const body = {
                customerId: parseInt(sessionCustomerId),
                items: [{ variantId: parseInt(variantId), quantity: quantity }],
                orderInfo: "Thanh to√°n " + productName
            };

            // L·∫•y CSRF meta n·∫øu c√≥
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

            try {
                const res = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    // th·ª≠ l·∫•y th√¥ng b√°o l·ªói ng·∫Øn
                    let text;
                    try { text = await res.text(); } catch (e) { text = ''; }
                    console.error('Payment create failed', res.status, text);
                    alert('Kh√¥ng th·ªÉ t·∫°o thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
                    return;
                }

                const data = await res.json();
                if (data && data.paymentUrl) {
                    // chuy·ªÉn sang URL thanh to√°n (VNPAY...)
                    window.location.href = data.paymentUrl;
                } else {
                    console.error('Payment create response lacks paymentUrl:', data);
                    alert('Kh√¥ng c√≥ URL thanh to√°n tr·∫£ v·ªÅ.');
                }
            } catch (err) {
                console.error('Error creating payment', err);
                alert('C√≥ l·ªói x·∫£y ra khi t·∫°o thanh to√°n!');
            }
        });

        // G·ª£i √Ω: n·∫øu b·∫°n mu·ªën b·∫Øt s·ª± ki·ªán submit form cart ƒë·ªÉ g·ª≠i ajax thay v√¨ reload,
        // c√≥ th·ªÉ th√™m preventDefault v√† fetch t·ªõi /cart/add (nh∆∞ng hi·ªán ƒë·ªÉ form ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng).
    });
    /*]]>*/
</script>

</body>
</html>
