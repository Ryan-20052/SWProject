<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử Báo cáo | License Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
        }

        .navbar {
            background-color: var(--primary-color) !important;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: none;
        }

        .navbar-dark .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9);
        }

        .navbar-dark .navbar-nav .nav-link:hover {
            color: rgba(255, 255, 255, 1);
        }

        .stat-card {
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }

        .badge-approved {
            background-color: #198754;
            color: #fff;
        }

        .badge-rejected {
            background-color: #dc3545;
            color: #fff;
        }

        .table th {
            border-top: none;
            font-weight: 600;
        }

        .btn-group .btn {
            margin-right: 5px;
        }

        .bulk-actions {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .checkbox-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-active {
            background-color: #0d6efd !important;
            color: white !important;
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" th:href="@{/home/homepage}">
            <i class="bi bi-shop me-2"></i>License Shop
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/home/homepage}">
                        <i class="bi bi-house-door me-1"></i> Trang chủ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/report/view}">
                        <i class="bi bi-plus-circle me-1"></i> Gửi báo cáo mới
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">
                        <i class="bi bi-clock-history me-1"></i> Lịch sử báo cáo
                    </a>
                </li>
            </ul>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container mt-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-file-alt me-2"></i> Lịch sử Báo cáo</h1>
        <a th:href="@{/report/view}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> Tạo báo cáo mới
        </a>
    </div>

    <!-- Flash Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary stat-card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-alt me-2"></i> Tổng báo cáo</h5>
                    <h2 th:text="${statistics.total}" class="mb-0"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning stat-card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-clock me-2"></i> Đang chờ</h5>
                    <h2 th:text="${statistics.pending}" class="mb-0"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success stat-card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-check-circle me-2"></i> Đã phê duyệt</h5>
                    <h2 th:text="${statistics.approved}" class="mb-0"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger stat-card">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-times-circle me-2"></i> Đã từ chối</h5>
                    <h2 th:text="${statistics.rejected}" class="mb-0"></h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Bộ lọc trạng thái -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title"><i class="fas fa-filter me-2"></i> Lọc theo trạng thái</h5>
            <div class="btn-group" role="group">
                <a th:href="@{/history/filter(status='all')}"
                   class="btn btn-outline-primary"
                   th:classappend="${currentFilter == 'all' or currentFilter == null} ? 'filter-active' : ''">
                    Tất cả (<span th:text="${statistics.total}"></span>)
                </a>
                <a th:href="@{/history/filter(status='pending')}"
                   class="btn btn-outline-warning"
                   th:classappend="${currentFilter == 'pending'} ? 'filter-active' : ''">
                    Đang chờ (<span th:text="${statistics.pending}"></span>)
                </a>
                <a th:href="@{/history/filter(status='approved')}"
                   class="btn btn-outline-success"
                   th:classappend="${currentFilter == 'approved'} ? 'filter-active' : ''">
                    Đã phê duyệt (<span th:text="${statistics.approved}"></span>)
                </a>
                <a th:href="@{/history/filter(status='rejected')}"
                   class="btn btn-outline-danger"
                   th:classappend="${currentFilter == 'rejected'} ? 'filter-active' : ''">
                    Đã từ chối (<span th:text="${statistics.rejected}"></span>)
                </a>
            </div>
        </div>
    </div>

    <!-- Bulk Actions - Chỉ hiển thị khi có báo cáo pending được chọn -->
    <div class="bulk-actions" id="bulkActions" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="selectedCount">0 báo cáo được chọn</span>
                <small id="pendingOnlyHint" class="text-muted ms-2" style="display: none;">
                    (Chỉ có thể xóa báo cáo đang chờ xử lý)
                </small>
            </div>
            <button type="button" class="btn btn-danger" onclick="deleteSelectedReports()">
                <i class="fas fa-trash me-2"></i> Xóa các báo cáo đang chờ đã chọn
            </button>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i> Danh sách báo cáo</h5>
            <div class="form-check" th:if="${currentFilter == 'pending' or currentFilter == 'all' or currentFilter == null}">
                <input class="form-check-input" type="checkbox" id="selectAllPending">
                <label class="form-check-label" for="selectAllPending">Chọn tất cả báo cáo đang chờ</label>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                    <tr>
                        <th width="50px" th:if="${currentFilter == 'pending' or currentFilter == 'all' or currentFilter == null}">Chọn</th>
                        <th>ID</th>
                        <th>Tiêu đề</th>
                        <th>Người gửi</th>
                        <th>Email</th>
                        <th>Sản phẩm</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="report : ${reports}">
                        <!-- CHỈ CHO PHÉP CHỌN BÁO CÁO PENDING -->
                        <td th:if="${currentFilter == 'pending' or currentFilter == 'all' or currentFilter == null}">
                            <input type="checkbox"
                                   class="report-checkbox"
                                   th:value="${report.id}"
                                   th:disabled="${report.status != 'pending'}"
                                   th:classappend="${report.status != 'pending'} ? 'checkbox-disabled' : ''">
                        </td>
                        <td th:text="${report.id}"></td>
                        <td th:text="${report.title}"></td>
                        <td th:text="${report.name}"></td>
                        <td th:text="${report.email}"></td>
                        <td>
                            <span th:if="${report.productId != null}" th:text="${report.productId}"></span>
                            <span th:if="${report.productId == null}" class="text-muted">Không có</span>
                        </td>
                        <td>
                            <span th:if="${report.status == 'pending'}"
                                  class="badge badge-pending">
                                <i class="fas fa-clock me-1"></i> Đang chờ
                            </span>
                            <span th:if="${report.status == 'approved'}"
                                  class="badge badge-approved">
                                <i class="fas fa-check me-1"></i> Đã phê duyệt
                            </span>
                            <span th:if="${report.status == 'rejected'}"
                                  class="badge badge-rejected">
                                <i class="fas fa-times me-1"></i> Đã từ chối
                            </span>
                        </td>
                        <td th:text="${#temporals.format(report.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{/history/view/{id}(id=${report.id})}"
                                   class="btn btn-sm btn-outline-primary"
                                   title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <!-- CHỈ HIỂN THỊ NÚT CHỈNH SỬA CHO BÁO CÁO PENDING -->
                                <a th:href="@{/history/edit/{id}(id=${report.id})}"
                                   th:if="${report.status == 'pending'}"
                                   class="btn btn-sm btn-outline-warning"
                                   title="Chỉnh sửa trạng thái">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <!-- CHỈ HIỂN THỊ NÚT XÓA CHO BÁO CÁO PENDING -->
                                <form th:if="${report.status == 'pending'}"
                                      th:action="@{/history/delete/{id}(id=${report.id})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('Bạn có chắc muốn xóa báo cáo này?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                <!-- THÔNG BÁO CHO BÁO CÁO ĐÃ XỬ LÝ -->
                                <span th:if="${report.status != 'pending'}"
                                      class="text-muted small"
                                      title="Báo cáo đã được xử lý không thể chỉnh sửa hoặc xóa">
                                    Đã xử lý
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.size(reports) == 0}">
                        <td th:if="${currentFilter == 'pending' or currentFilter == 'all' or currentFilter == null}" colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>Không có báo cáo nào.</p>
                            <a th:href="@{/report/view}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i> Tạo báo cáo đầu tiên
                            </a>
                        </td>
                        <td th:if="${currentFilter != 'pending' and currentFilter != 'all' and currentFilter != null}" colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>Không có báo cáo nào với trạng thái này.</p>
                            <a th:href="@{/history}" class="btn btn-primary">
                                <i class="fas fa-list me-2"></i> Xem tất cả báo cáo
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-light py-4 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h5><i class="bi bi-shop me-2"></i>License Shop</h5>
                <p class="mb-0">Cung cấp các giải pháp phần mềm và bản quyền chính hãng.</p>
            </div>
            <div class="col-md-6 text-md-end">
                <p class="mb-0">&copy; 2023 License Shop. All rights reserved.</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Tự động ẩn thông báo sau 5 giây
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(function() {
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        });

        // Khởi tạo chức năng chọn nhiều (chỉ khi có báo cáo pending)
        initBulkActions();
    });

    // Chức năng chọn nhiều báo cáo PENDING để xóa
    function initBulkActions() {
        const selectAllPending = document.getElementById('selectAllPending');
        if (!selectAllPending) return;

        const checkboxes = document.querySelectorAll('.report-checkbox:not([disabled])');

        // Chọn tất cả báo cáo PENDING
        selectAllPending.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = this.checked;
                }
            });
            updateBulkActions();
        });

        // Cập nhật trạng thái khi chọn từng checkbox
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
    }

    // Cập nhật hiển thị nút xóa nhiều
    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        const selectAllPending = document.getElementById('selectAllPending');
        const pendingOnlyHint = document.getElementById('pendingOnlyHint');

        if (!bulkActions) return;

        const totalPendingBoxes = document.querySelectorAll('.report-checkbox:not([disabled])').length;
        const allPendingChecked = checkedBoxes.length === totalPendingBoxes && totalPendingBoxes > 0;

        selectedCount.textContent = checkedBoxes.length + ' báo cáo đang chờ được chọn';
        bulkActions.style.display = checkedBoxes.length > 0 ? 'block' : 'none';
        pendingOnlyHint.style.display = checkedBoxes.length > 0 ? 'inline' : 'none';

        // Cập nhật trạng thái chọn tất cả báo cáo pending
        if (selectAllPending) {
            selectAllPending.checked = allPendingChecked;
            selectAllPending.indeterminate = checkedBoxes.length > 0 && !allPendingChecked;
        }
    }

    // Xóa các báo cáo PENDING đã chọn
    function deleteSelectedReports() {
        const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);

        if (selectedIds.length === 0) {
            alert('Vui lòng chọn ít nhất một báo cáo đang chờ xử lý để xóa.');
            return;
        }

        if (confirm(`Bạn có chắc muốn xóa ${selectedIds.length} báo cáo đang chờ xử lý?`)) {
            // Tạo form để gửi request xóa nhiều
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/history/delete-multiple';

            // Thêm các ID vào form
            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'reportIds';
                input.value = id;
                form.appendChild(input);
            });

            // Thêm CSRF token nếu có
            const csrfToken = document.querySelector('input[name="_csrf"]');
            if (csrfToken) {
                form.appendChild(csrfToken.cloneNode());
            }

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
</body>
</html>