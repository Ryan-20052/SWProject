<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử Báo cáo | License Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            border: none;
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .pagination-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <!-- Nút quay lại -->
    <div class="mb-3">
        <a href="http://localhost:8080/report/view" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Quay lại trang báo cáo
        </a>
    </div>

    <!-- Flash Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-history me-2"></i>Lịch sử Báo cáo</h4>
        </div>
        <div class="card-body">
            <!-- Bộ lọc -->
            <div class="filter-section">
                <h5><i class="fas fa-filter me-2"></i>Bộ lọc</h5>

                <!-- Tìm kiếm theo chữ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">Tìm kiếm theo từ khóa</label>
                        <input type="text"
                               class="form-control"
                               id="searchInput"
                               placeholder="Tìm theo tên, email, nội dung...">
                    </div>
                </div>

                <!-- Bộ lọc theo ngày và tiêu đề -->
                <form th:action="@{/history/filter}" method="get" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="startDate" class="form-label">Từ ngày</label>
                        <input type="date"
                               class="form-control"
                               id="startDate"
                               name="startDate"
                               th:value="${startDate}">
                    </div>
                    <div class="col-md-2">
                        <label for="endDate" class="form-label">Đến ngày</label>
                        <input type="date"
                               class="form-control"
                               id="endDate"
                               name="endDate"
                               th:value="${endDate}">
                    </div>
                    <div class="col-md-2">
                        <label for="titleFilter" class="form-label">Tiêu đề</label>
                        <select class="form-select" id="titleFilter" name="title">
                            <option value="">Tất cả tiêu đề</option>
                            <option value="Đề xuất" th:selected="${currentTitle == 'Đề xuất'}">Đề xuất</option>
                            <option value="Báo cáo" th:selected="${currentTitle == 'Báo cáo'}">Báo cáo</option>
                            <option value="Phản hồi" th:selected="${currentTitle == 'Phản hồi'}">Phản hồi</option>
                            <option value="Khiếu nại" th:selected="${currentTitle == 'Khiếu nại'}">Khiếu nại</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="statusFilter" class="form-label">Trạng thái</label>
                        <select class="form-select" id="statusFilter" name="status">
                            <option value="all" th:selected="${currentFilter == 'all'}">Tất cả trạng thái</option>
                            <option value="pending" th:selected="${currentFilter == 'pending'}">Đang chờ</option>
                            <option value="approved" th:selected="${currentFilter == 'approved'}">Đã phê duyệt</option>
                            <option value="rejected" th:selected="${currentFilter == 'rejected'}">Đã từ chối</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="pageSize" class="form-label">Số lượng / trang</label>
                        <select class="form-select" id="pageSize" name="size">
                            <option value="5" th:selected="${pageSize == 5}">5</option>
                            <option value="10" th:selected="${pageSize == 10}">10</option>
                            <option value="20" th:selected="${pageSize == 20}">20</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                        </select>
                    </div>
                    <div class="col-md-2 mt-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                    </div>
                    <div class="col-md-12 mt-2">
                        <a th:href="@{/history}" class="btn btn-outline-secondary">
                            <i class="fas fa-refresh me-2"></i>Xóa bộ lọc
                        </a>
                    </div>
                </form>
            </div>

            <!-- Thông tin phân trang -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="text-muted">
                        Hiển thị <strong th:text="${reports.size()}">0</strong>
                        trên tổng số <strong th:text="${totalItems}">0</strong> báo cáo
                    </span>
                </div>
                <div>
                    <span class="text-muted">
                        Trang <strong th:text="${currentPage + 1}">1</strong>
                        / <strong th:text="${totalPages}">1</strong>
                    </span>
                </div>
            </div>

            <!-- Danh sách báo cáo -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="reportsTable">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Họ tên</th>
                        <th>Email</th>
                        <th>Tiêu đề</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="report : ${reports}">
                        <td th:text="${report.id}"></td>
                        <td th:text="${report.name}"></td>
                        <td th:text="${report.email}"></td>
                        <td>
                            <!-- Hiển thị tiêu đề đẹp từ mapping -->
                            <span th:if="${titleMapping[report.title] != null}"
                                  th:text="${titleMapping[report.title]}">
                            </span>
                            <span th:if="${titleMapping[report.title] == null}"
                                  th:text="${report.title}">
                            </span>
                        </td>
                        <td>
                                <span th:if="${report.status == 'pending'}"
                                      class="badge bg-warning status-badge">Đang chờ xử lý</span>
                            <span th:if="${report.status == 'approved'}"
                                  class="badge bg-success status-badge">Đã phê duyệt</span>
                            <span th:if="${report.status == 'rejected'}"
                                  class="badge bg-danger status-badge">Đã từ chối</span>
                        </td>
                        <td th:text="${#temporals.format(report.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{/history/view/{id}(id=${report.id})}"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a th:if="${report.status == 'pending'}"
                                   th:href="@{/history/edit/{id}(id=${report.id})}"
                                   class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form th:if="${report.status == 'pending'}"
                                      th:action="@{/history/delete/{id}(id=${report.id})}"
                                      method="post"
                                      style="display: inline;">
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Bạn có chắc muốn xóa báo cáo này?')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(reports)}">
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Không có báo cáo nào
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Phân trang -->
            <div th:if="${totalPages > 1}" class="pagination-container">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <!-- Nút trang đầu -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/history(page=0, size=${pageSize})}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>

                        <!-- Nút trang trước -->
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/history(page=${currentPage - 1}, size=${pageSize})}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>

                        <!-- Các trang -->
                        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            class="page-item"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{/history(page=${i}, size=${pageSize})}"
                               th:text="${i + 1}"></a>
                        </li>

                        <!-- Nút trang sau -->
                        <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/history(page=${currentPage + 1}, size=${pageSize})}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>

                        <!-- Nút trang cuối -->
                        <li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/history(page=${totalPages - 1}, size=${pageSize})}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tự động ẩn thông báo sau 5 giây
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(function() {
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        });

        // Tìm kiếm theo chữ
        const searchInput = document.getElementById('searchInput');
        const reportsTable = document.getElementById('reportsTable');
        const rows = reportsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < cells.length - 1; j++) {
                    const cellText = cells[j].textContent || cells[j].innerText;
                    if (cellText.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }

                rows[i].style.display = found ? '' : 'none';
            }
        });

        // Đặt giá trị mặc định cho ngày (30 ngày gần nhất)
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (!startDateInput.value) {
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        if (!endDateInput.value) {
            endDateInput.value = today.toISOString().split('T')[0];
        }
    });
</script>
</body>
</html>