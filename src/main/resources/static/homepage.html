<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Shop</title>
    <link rel="stylesheet" href="homepage.css">

    <style>
        :root{--blue:#2563eb;--blue-dark:#1d4ed8}
        body { font-family: Arial, sans-serif; margin: 0; background: #f8f9fa; color:#111 }
        header { background: var(--blue); color: white; padding: 15px 20px; display: flex; justify-content: center; align-items: center; }
        .header-inner { width: 1200px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        header h1 { font-size: 20px; margin: 0; white-space: nowrap; }
        .search-box { flex: 1; display: flex; justify-content: center; }
        .search-box input { width: 100%; max-width: 600px; padding: 10px 14px; border-radius: 6px; border: none; }

        /* search control nhỏ gọn */
        .search-controls { display:flex; gap:8px; align-items:center; width:100%; max-width:600px; }
        .search-controls input { flex:1; padding:10px 12px; border-radius:6px; border:none; }
        .search-clear { background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:8px 10px; border-radius:6px; cursor:pointer;}
        .search-clear.hidden { display:none; }

        header .actions { display: flex; gap: 10px; align-items: center; }
        header button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }

        nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
        .nav-inner { width: 1200px; margin: 0 auto; display: flex; justify-content: center; gap: 24px; padding: 10px 20px; font-weight: 600; }

        .banner { margin: 20px auto; padding: 34px; border-radius: 12px; background: linear-gradient(90deg, #4ade80, #3b82f6); color: white; text-align: center; max-width:1200px }

        .products { padding: 20px; text-align: center; max-width:1200px; margin:0 auto }
        .section-inner { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
        .content-inner { display: flex; flex-direction: column; align-items: flex-start; width: max-content; }
        .content-inner h2 { margin-bottom: 8px; text-align: left; }
        .content-inner .sub { color:#666; font-size:14px; margin-bottom:14px; text-align:left }

        .grid-featured { display: grid; grid-template-columns: repeat(4, 260px); gap: 30px; justify-content: center; align-items: start; }
        .grid-all { display: grid; grid-template-columns: repeat(4, 260px); gap: 30px; justify-content: center; align-items: start; }

        .card { background: white; border-radius: 10px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: 0.25s; width:100%; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .thumb { height: 140px; border-radius: 8px; background-size: cover; background-position: center; margin-bottom: 10px; }
        .card h3 { font-size: 15px; margin: 6px 0; height: 40px; overflow: hidden; text-align:left }
        .meta { display:flex; gap:8px; align-items:center; justify-content:space-between; }
        .price { color: #059669; font-weight:700 }
        .card .buy, .card .add-to-cart { margin-top:8px; width:100%; padding:10px; background:var(--blue); color:white; border:none; border-radius:8px; cursor:pointer }
        .card .buy:hover, .card .add-to-cart:hover { background:var(--blue-dark) }

        /* highlight khi tìm kiếm */
        .highlight { background: linear-gradient(90deg,#fff9c4,#fff3b0); padding: 0 4px; border-radius: 3px; }

        .no-results { text-align:center; color:#666; padding: 24px; width:100% }
    </style>
</head>
<body>
<header>
    <div class="header-inner">
        <h1>License Shop</h1>
        <div class="search-box">
            <div class="search-controls">
                <input id="searchInput" type="text" placeholder="Tìm sản phẩm theo tên, từ khoá..." />
                <button id="clearSearch" class="search-clear hidden">X</button>
            </div>
        </div>
        <div class="actions" id="actions">
            <!-- Ban đầu mặc định: nút login/register -->
            <button onclick="window.location.href='/login.html'">Đăng nhập / Đăng ký</button>
            <button id="cartBtn">Giỏ hàng (0)</button>
        </div>
    </div>
</header>


<nav>
    <div class="nav-inner">
        <span>Giải trí</span>
        <span>Làm việc</span>
        <span>Học tập</span>
        <span>windows</span>
        <span>VPN</span>
    </div>
</nav>

<div class="banner">
    <h2>Khuyến mãi siêu hot!</h2>
    <p>Giảm giá lên tới 80% cho các phần mềm bản quyền</p>
</div>

<section class="products">
    <div class="section-inner">
        <div class="content-inner">
            <h2>Sản phẩm nổi bật</h2>
            <div class="sub">Danh sách những sản phẩm theo xu hướng</div>
            <div class="grid-featured" id="featuredGrid"></div>
        </div>
    </div>
</section>

<section class="products">
    <div class="section-inner">
        <div class="content-inner">
            <h2>Tất cả sản phẩm</h2>
            <div class="sub">Danh sách đầy đủ sản phẩm</div>
            <div class="grid-all" id="allGrid"></div>
        </div>
    </div>
</section>

<script>
    /* ---------------- user menu logic (giữ nguyên) ---------------- */
    const actions = document.getElementById("actions");
    const username = sessionStorage.getItem("username");

    if (username) {
        actions.innerHTML = `
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar">${username.charAt(0).toUpperCase()}</div>
            <div class="dropdown" id="userDropdown">
                <a href="profile.html">Profile</a>
                <a href="purchased.html">Purchased License</a>
                <a href="#" id="logoutBtn">Log out</a>
            </div>
        </div>
        <button id="cartBtn">Giỏ hàng (0)</button>
        `;

        const avatar = document.getElementById("userAvatar");
        const dropdown = document.getElementById("userDropdown");

        avatar.addEventListener("click", () => {
            dropdown.classList.toggle("show");
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            sessionStorage.removeItem("username");
            window.location.href = "login.html";
        });

        // Click ra ngoài để đóng dropdown
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".user-menu")) {
                dropdown.classList.remove("show");
            }
        });
    } else {
        actions.innerHTML = `
        <button onclick="window.location.href='/login.html'">Đăng nhập / Đăng ký</button>
        <button id="cartBtn">Giỏ hàng (0)</button>
        `;
    }
</script>

<script>
    /* ---------------- products + search logic ---------------- */
    const featuredGrid = document.getElementById("featuredGrid");
    const allGrid = document.getElementById("allGrid");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearch");

    let cart = [];
    let allProducts = [];

    function addToCart(product, variant){
        cart.push({product, variant, qty:1});
        updateCartBtn();
    }

    function updateCartBtn(){
        const btn = document.getElementById("cartBtn");
        if (btn) btn.innerText = "Giỏ hàng ("+cart.length+")";
    }

    // Escape HTML để tránh XSS
    function escapeHtml(text) {
        if (!text) return "";
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    // Highlight từ khoá trong text (trả về HTML an toàn)
    function highlight(text, q) {
        if (!q) return escapeHtml(text);
        const safeQ = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`(${safeQ})`, 'ig');
        return escapeHtml(text).replace(re, '<span class="highlight">$1</span>');
    }

    function createCard(p, searchQuery = '') {
        const div = document.createElement('div');
        div.className = 'card';

        const v = p.variants && p.variants.length > 0 ? p.variants[0] : null;

        div.innerHTML = `
          <div class="thumb"></div>
          <h3>${highlight(p.name || '', searchQuery)}</h3>
          <div class="meta">
              <div style="text-align:left">
                  ${v ? `<div class="price">${v.price.toLocaleString()}đ</div>` : `<div class="price">Liên hệ</div>`}
              </div>
          </div>
          <button class="buy">Mua ngay</button>
          <button class="add-to-cart">Thêm vào giỏ hàng</button>
        `;

        const thumb = div.querySelector('.thumb');
        if (p.imgUrl) {
            // set background image an toàn qua JS
            thumb.style.backgroundImage = `url('${p.imgUrl}')`;
            thumb.style.backgroundSize = 'cover';
            thumb.style.backgroundPosition = 'center';
        } else {
            thumb.style.background = 'linear-gradient(90deg,#eef2ff,#e0f2fe)';
        }

        if(v){
            div.querySelector(".buy").addEventListener("click", ()=> {
                alert("Mua ngay: " + v.name + " - " + v.price.toLocaleString() + "đ");
            });
            div.querySelector(".add-to-cart").addEventListener("click", ()=> {
                addToCart(p, v);
            });
        }
        return div;
    }

    // render danh sách (featured + all)
    function renderProducts(list, query = '') {
        featuredGrid.innerHTML = '';
        allGrid.innerHTML = '';

        if (!list || list.length === 0) {
            const no = document.createElement('div');
            no.className = 'no-results';
            no.innerText = 'Không tìm thấy sản phẩm nào phù hợp.';
            allGrid.appendChild(no);
            return;
        }

        const featured = list.slice(0,4);
        featured.forEach(p => featuredGrid.appendChild(createCard(p, query)));
        list.forEach(p => allGrid.appendChild(createCard(p, query)));
    }

    // filter cục bộ theo tên, variant name hoặc imgUrl
    function filterProducts(query) {
        if (!query || query.trim() === '') return allProducts.slice();
        const q = query.trim().toLowerCase();
        return allProducts.filter(p => {
            const name = (p.name || '').toLowerCase();
            const variants = (p.variants || []).map(v => (v.name || '').toLowerCase()).join(' ');
            const img = (p.imgUrl || '').toLowerCase();
            return name.includes(q) || variants.includes(q) || img.includes(q);
        });
    }

    // debounce helper
    function debounce(fn, delay = 300) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // xử lý tìm kiếm
    const onSearchChange = debounce(() => {
        const q = searchInput.value;
        toggleClearBtn(q);
        const filtered = filterProducts(q);
        renderProducts(filtered, q);
    }, 250);

    function toggleClearBtn(q) {
        if (!q || q.trim() === '') {
            clearSearchBtn.classList.add('hidden');
        } else {
            clearSearchBtn.classList.remove('hidden');
        }
    }

    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        toggleClearBtn('');
        renderProducts(allProducts);
        searchInput.focus();
    });

    // Enter: nếu chỉ 1 kết quả -> redirect (tuỳ bạn implement page detail)
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const q = searchInput.value.trim();
            const filtered = filterProducts(q);
            if (filtered.length === 1) {
                window.location.href = `/product.html?id=${filtered[0].id}`;
            } else {
                renderProducts(filtered, q);
            }
        }
    });

    searchInput.addEventListener('input', onSearchChange);

    // load products từ API
    async function loadProducts(){
        try {
            const res = await fetch("http://localhost:8080/api/product");
            if (!res.ok) {
                console.error('Fetch failed', res.status, res.statusText);
                allGrid.innerHTML = '<div class="no-results">Không thể tải sản phẩm. Kiểm tra server hoặc CORS.</div>';
                return;
            }
            const products = await res.json();
            console.log('products:', products);
            allProducts = products || [];
            renderProducts(allProducts);
        } catch (err) {
            console.error('Error loading products:', err);
            allGrid.innerHTML = '<div class="no-results">Lỗi khi tải sản phẩm. Mở console để xem chi tiết.</div>';
        }
    }

    loadProducts();
</script>

</body>
</html>
