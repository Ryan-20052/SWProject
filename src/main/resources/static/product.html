<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chi tiết sản phẩm — License Shop</title>
    <link rel="stylesheet" href="homepage.css">
    <style>
        .star {
            font-size: 22px;
            cursor: pointer;
            color: #ccc;
        }
        .star.selected,
        .star:hover,
        .star:hover ~ .star { color: gold; }

        :root{--blue:#2563eb;--blue-dark:#1d4ed8}
        body { font-family: Arial, sans-serif; margin: 0; background: #f8f9fa; color:#111 }
        header { background: var(--blue); color: white; padding: 15px 20px; display: flex; justify-content: center; align-items: center; }
        .header-inner { width: 1200px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        header h1 { font-size: 20px; margin: 0; white-space: nowrap; }
        .search-box { flex: 1; display: flex; justify-content: center; }
        .search-box input { width: 100%; max-width: 600px; padding: 10px 14px; border-radius: 6px; border: none; }

        .search-controls { display:flex; gap:8px; align-items:center; width:100%; max-width:600px; }
        .search-controls input { flex:1; padding:10px 12px; border-radius:6px; border:none; }
        .search-clear { background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:8px 10px; border-radius:6px; cursor:pointer;}
        .search-clear.hidden { display:none; }

        header .actions { display: flex; gap: 10px; align-items: center; }
        header button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }

        nav { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
        .nav-inner { width: 1200px; margin: 0 auto; display: flex; justify-content: center; gap: 24px; padding: 10px 20px; font-weight: 600; }
        .nav-inner span { cursor:pointer; }

        .banner { margin: 20px auto; padding: 34px; border-radius: 12px; background: linear-gradient(90deg, #4ade80, #3b82f6); color: white; text-align: center; max-width:1200px }

        .products { padding: 20px; text-align: center; max-width:1200px; margin:0 auto }
        .section-inner { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }

        /* product detail card - match homepage look */
        .product-wrap { display:flex; gap:20px; width:100%; max-width:1100px; margin:18px auto; align-items:flex-start; }
        .prod-left, .prod-right { background:white; border-radius:10px; padding:14px; box-shadow:0 4px 16px rgba(0,0,0,0.06) }
        .prod-left { width:420px; min-height:280px; display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center }
        .prod-thumb { width:100%; height:280px; border-radius:8px; background-size:cover; background-position:center; }
        .prod-meta { text-align:left; width:100% }
        .prod-right { flex:1; display:flex; flex-direction:column; gap:12px; }
        .prod-title { font-size:20px; margin:0 }
        .prod-cat { color:#666; font-size:14px }
        .prod-desc { color:#444; font-size:14px; margin-top:8px }
        .variants { display:flex; flex-direction:column; gap:10px; margin-top:6px }
        .variant-row { display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; border:1px solid #f0f0f0; justify-content:space-between }
        .variant-info { display:flex; gap:8px; align-items:center }
        .price { color:#059669; font-weight:700; font-size:16px }
        .actions { display:flex; gap:12px; margin-top:12px; }
        .btn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer }
        .btn-buy { background:var(--blue); color:white }
        .btn-cart { background:#f3f4f6; color:#111 }
        .no-variants { color:#666 }
        .qty { display:flex; align-items:center; gap:8px; }
        .small { font-size:13px; color:#666 }

        .breadcrumb { width:100%; max-width:1100px; margin:8px auto; text-align:left; color:#444; font-size:14px }
        .breadcrumb a { color:var(--blue); text-decoration:none }

        /* responsive */
        @media (max-width: 900px) {
            .product-wrap { flex-direction:column; padding:10px }
            .prod-left { width:100% }
            .prod-thumb { height:220px }
        }
    </style>
</head>
<body>
<header>
    <div class="header-inner">
        <h1>License Shop</h1>
        <div class="search-box">
            <div class="search-controls">
                <input id="searchInput" type="text" placeholder="Tìm sản phẩm theo tên, từ khoá..." />
                <button id="clearSearch" class="search-clear hidden">X</button>
            </div>
        </div>
        <div class="actions" id="actions">
            <button onclick="window.location.href='/login.html'">Đăng nhập / Đăng ký</button>
            <button id="cartBtn">Giỏ hàng (0)</button>
        </div>
    </div>
</header>

<nav>
    <div class="nav-inner">
        <span data-cat="giaitri">Giải trí</span>
        <span data-cat="lamviec">Làm việc</span>
        <span data-cat="hoctap">Học tập</span>
        <span data-cat="windows">windows</span>
        <span data-cat="vpn">VPN</span>
    </div>
</nav>

<div class="banner">
    <h2>Khuyến mãi siêu hot!</h2>
    <p>Giảm giá lên tới 80% cho các phần mềm bản quyền</p>
</div>

<div class="breadcrumb">
    <a href="/homepage.html">Trang chủ</a> &nbsp;›&nbsp; <span id="crumbProduct">Chi tiết sản phẩm</span>
</div>

<section class="products">
    <div class="section-inner">
        <div class="product-wrap" id="productWrap">
            <div class="prod-left">
                <div id="prodThumb" class="prod-thumb"></div>
                <div class="prod-meta" style="width:100%;text-align:left">
                    <div class="small">Ảnh sản phẩm</div>
                </div>
            </div>

            <div class="prod-right">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h2 id="prodName" class="prod-title">Đang tải...</h2>
                        <div id="prodCat" class="prod-cat"></div>
                    </div>
                    <div id="priceBox" class="price">Giá: -</div>
                </div>

                <div id="prodDesc" class="prod-desc"></div>

                <div>
                    <div class="small">Chọn phiên bản (thời hạn)</div>
                    <div id="variants" class="variants"></div>
                    <div id="noVariants" class="no-variants" style="display:none">Không có phiên bản cho sản phẩm này.</div>
                </div>

                <div style="display:flex;gap:18px;align-items:center">
                    <div>
                        <div class="small">Số lượng</div>
                        <div class="qty">
                            <button id="decQty" class="btn">−</button>
                            <input id="qtyInput" type="number" value="1" min="1" style="width:68px;padding:8px;border-radius:6px;border:1px solid #ddd" />
                            <button id="incQty" class="btn">+</button>
                        </div>
                    </div>

                    <div class="actions" style="margin-left:auto">
                        <button id="buyNowBtn" class="btn btn-buy">Mua ngay</button>
                        <button id="addCartBtn" class="btn btn-cart">Thêm vào giỏ hàng</button>
                    </div>
                </div>

                <div id="message" class="small" style="color:green;display:none;margin-top:8px"></div>
            </div>
        </div>

        <!-- Gợi ý các sản phẩm cùng category (tái sử dụng grid của homepage) -->
        <div style="width:100%;max-width:1100px;margin:20px auto;text-align:left">
            <h3>Sản phẩm cùng loại</h3>
            <!-- Thêm vào ngay sau phần "Sản phẩm cùng loại" -->
            <div style="width:100%;max-width:1100px;margin:30px auto;text-align:left">
                <h3>Đánh giá sản phẩm</h3>

                <!-- Form đánh giá -->
                <div style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:16px">
                    <div style="margin-bottom:10px">
                        <label>Chọn số sao:</label>
                        <span id="ratingStars">
                <!-- sao hiển thị bằng button -->
                <span class="star" data-val="1">☆</span>
                <span class="star" data-val="2">☆</span>
                <span class="star" data-val="3">☆</span>
                <span class="star" data-val="4">☆</span>
                <span class="star" data-val="5">☆</span>
            </span>
                    </div>
                    <textarea id="reviewComment" placeholder="Nhập nhận xét..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px"></textarea>
                    <button id="submitReview" class="btn btn-buy" style="margin-top:10px">Gửi đánh giá</button>
                </div>

                <!-- Danh sách review -->
                <div id="reviewsList" style="display:flex;flex-direction:column;gap:12px"></div>
            </div>

            <div id="relatedGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:12px"></div>
        </div>
    </div>
</section>

<script>
    /* ---------- Utility & header behavior (giống homepage) ---------- */
    const actions = document.getElementById("actions");
    const username = sessionStorage.getItem("username");
    const cartBtn = document.getElementById("cartBtn");
    function updateCartCountUI(){
        try {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cartBtn) cartBtn.innerText = `Giỏ hàng (${cart.length})`;
        } catch(e){
            if (cartBtn) cartBtn.innerText = 'Giỏ hàng (0)';
        }
    }

    if (username) {
        actions.innerHTML = `
    <div class="user-menu">
        <div class="user-avatar" id="userAvatar">${username.charAt(0).toUpperCase()}</div>
        <div class="dropdown" id="userDropdown">
            <a href="profile.html">Profile</a>
            <a href="purchased.html">Purchased License</a>
            <a href="#" id="logoutBtn">Log out</a>
        </div>
    </div>
    <button id="cartBtn">Giỏ hàng (0)</button>
    `;
        const avatar = document.getElementById("userAvatar");
        const dropdown = document.getElementById("userDropdown");
        avatar.addEventListener("click", () => dropdown.classList.toggle("show"));
        document.getElementById("logoutBtn").addEventListener("click", () => {
            sessionStorage.removeItem("username");
            window.location.href = "login.html";
        });
        document.addEventListener("click", (e) => { if (!e.target.closest(".user-menu")) dropdown.classList.remove("show"); });
    } else {
        // actions already contains default buttons in static markup; ensure cartBtn reference is current
        // (nothing to do)
    }
    updateCartCountUI();

    // search box simple behavior: nếu enter => chuyển về homepage với query
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const q = searchInput.value.trim();
            // redirect to homepage (homepage has client-side search)
            window.location.href = `/homepage.html?q=${encodeURIComponent(q)}`;
        }
    });
    clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; clearSearchBtn.classList.add('hidden'); });
    searchInput.addEventListener('input', () => {
        if (searchInput.value.trim() === '') clearSearchBtn.classList.add('hidden'); else clearSearchBtn.classList.remove('hidden');
    });

    /* -------------- product loading & render -------------- */
    function qParam(name){
        const u = new URL(location.href);
        return u.searchParams.get(name);
    }
    const productId = qParam('id');
    const prodThumb = document.getElementById('prodThumb');
    const prodName = document.getElementById('prodName');
    const prodCat = document.getElementById('prodCat');
    const prodDesc = document.getElementById('prodDesc');
    const variantsEl = document.getElementById('variants');
    const noVariantsEl = document.getElementById('noVariants');
    const priceBox = document.getElementById('priceBox');
    const qtyInput = document.getElementById('qtyInput');
    const decQty = document.getElementById('decQty');
    const incQty = document.getElementById('incQty');
    const buyNowBtn = document.getElementById('buyNowBtn');
    const addCartBtn = document.getElementById('addCartBtn');
    const messageEl = document.getElementById('message');
    const crumbProduct = document.getElementById('crumbProduct');
    const relatedGrid = document.getElementById('relatedGrid');

    let product = null;
    let selectedVariant = null;
    let relatedProducts = [];

    // load product
    if (!productId) {
        prodName.innerText = 'Sản phẩm không hợp lệ';
    } else {
        loadProduct(productId);
    }

    async function loadProduct(id){
        try {
            const res = await fetch(`http://localhost:8080/api/product/${encodeURIComponent(id)}`);
            if (!res.ok) {
                prodName.innerText = 'Không tải được sản phẩm';
                console.error('Fetch product failed', res.status, res.statusText);
                return;
            }
            product = await res.json();
            renderProduct(product);
            // load related (theo categoryId nếu có)
            if (product.categoryId) {
                loadRelated(product.categoryId, product.id);
            }
        } catch (err) {
            prodName.innerText = 'Lỗi khi tải sản phẩm';
            console.error(err);
        }
    }

    function renderProduct(p){
        prodName.innerText = p.name || 'Không có tên';
        crumbProduct.innerText = p.name || 'Chi tiết sản phẩm';
        prodCat.innerText = p.categoryName ? `Thể loại: ${p.categoryName}` : '';
        prodDesc.innerText = p.description || (p.shortDescription || '') ;

        if (p.imgUrl) {
            prodThumb.style.backgroundImage = `url('${p.imgUrl}')`;
        } else {
            prodThumb.style.background = 'linear-gradient(90deg,#eef2ff,#e0f2fe)';
        }

        // variants ordering: 3 tháng,6 tháng,9 tháng,1 năm
        const orderDurations = [
            {keys:['3 tháng','3tháng','3 month','3 tháng']},
            {keys:['6 tháng','6tháng','6 month']},
            {keys:['9 tháng','9tháng','9 month']},
            {keys:['1 năm','12 tháng','12month','1 year']}
        ];

        variantsEl.innerHTML = '';
        const variants = p.variants || [];

        if (variants.length === 0) {
            noVariantsEl.style.display = 'block';
            priceBox.innerText = 'Giá: -';
            return;
        } else {
            noVariantsEl.style.display = 'none';
        }

        // map preferred order
        const rem = [...variants];
        const mapped = [];
        orderDurations.forEach(o => {
            const found = rem.find(v => {
                const t = ((v.duration || '') + ' ' + (v.name || '')).toLowerCase();
                return o.keys.some(k => t.includes(k));
            });
            if (found) {
                mapped.push(found);
                rem.splice(rem.indexOf(found), 1);
            }
        });
        const finalList = mapped.concat(rem);

        finalList.forEach((v, idx) => {
            const row = document.createElement('label');
            row.className = 'variant-row';
            row.innerHTML = `
            <div class="variant-info">
                <input type="radio" name="variant" value="${v.id}" ${idx===0? 'checked' : ''}/>
                <div>
                    <div style="font-weight:600">${escapeHtml(v.name || v.duration || 'Phiên bản')}</div>
                    <div class="small">${escapeHtml(v.duration || '')}</div>
                </div>
            </div>
            <div class="price">${v.price ? (v.price.toLocaleString() + 'đ') : 'Liên hệ'}</div>
        `;
            variantsEl.appendChild(row);
            if (idx === 0) selectedVariant = v;
        });

        updatePriceFromSelected();

        // radio change listener
        variantsEl.querySelectorAll('input[name="variant"]').forEach(r => {
            r.addEventListener('change', (e) => {
                const vid = parseInt(e.target.value);
                selectedVariant = (product.variants || []).find(x => x.id === vid) || null;
                updatePriceFromSelected();
            });
        });
    }

    function updatePriceFromSelected(){
        if (!selectedVariant) {
            const first = variantsEl.querySelector('input[name="variant"]');
            if (first) {
                first.checked = true;
                const vid = parseInt(first.value);
                selectedVariant = (product.variants || []).find(x => x.id === vid);
            }
        }
        const q = Math.max(1, parseInt(qtyInput.value) || 1);
        if (selectedVariant && selectedVariant.price) {
            priceBox.innerText = 'Giá: ' + (selectedVariant.price * q).toLocaleString() + 'đ';
        } else {
            priceBox.innerText = 'Giá: Liên hệ';
        }
    }

    // qty buttons
    decQty.addEventListener('click', ()=> { qtyInput.value = Math.max(1, parseInt(qtyInput.value) - 1); updatePriceFromSelected(); });
    incQty.addEventListener('click', ()=> { qtyInput.value = Math.max(1, parseInt(qtyInput.value) + 1); updatePriceFromSelected(); });
    qtyInput.addEventListener('change', ()=> { if (qtyInput.value < 1) qtyInput.value = 1; updatePriceFromSelected(); });

    // local cart helpers
    function loadCart(){
        try { return JSON.parse(localStorage.getItem('cart') || '[]'); }
        catch(e) { return []; }
    }
    function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); updateCartCountUI(); }

    function addToCartLocal(product, variant, qty){
        const cart = loadCart();
        const existing = cart.find(i => i.productId === product.id && i.variantId === variant.id);
        if (existing) existing.qty += qty;
        else cart.push({
            productId: product.id,
            variantId: variant.id,
            qty: qty,
            name: product.name,
            variantName: variant.name || variant.duration,
            price: variant.price,
            imgUrl: product.imgUrl || null
        });
        saveCart(cart);
    }

    addCartBtn.addEventListener('click', () => {
        if (!product || !selectedVariant) { alert('Vui lòng chọn sản phẩm / phiên bản.'); return; }
        const qty = Math.max(1, parseInt(qtyInput.value) || 1);
        addToCartLocal(product, selectedVariant, qty);
        messageEl.style.display = 'block';
        messageEl.innerText = `Đã thêm ${qty} x ${product.name} (${selectedVariant.name || selectedVariant.duration}) vào giỏ hàng.`;
        setTimeout(()=> messageEl.style.display = 'none', 3500);
    });

    buyNowBtn.addEventListener('click', () => {
        if (!product || !selectedVariant) { alert('Vui lòng chọn sản phẩm / phiên bản.'); return; }
        const qty = Math.max(1, parseInt(qtyInput.value) || 1);
        addToCartLocal(product, selectedVariant, qty);
        // redirect tới checkout (nếu có). Nếu chưa có, redirect tới cart page.
        const params = new URLSearchParams();
        params.set('productId', product.id);
        params.set('variantId', selectedVariant.id);
        params.set('qty', qty);
        // change path if your checkout page is different
        window.location.href = `/checkout.html?${params.toString()}`;
    });

    /* ------------- related products (simple) ------------- */
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function loadRelated(categoryId, excludeId){
        try {
            // sử dụng endpoint search để lấy 8 sản phẩm cùng category (page 0, size 8)
            const url = `http://localhost:8080/api/product/search?categoryId=${encodeURIComponent(categoryId)}&page=0&size=8`;
            const res = await fetch(url);
            if (!res.ok) return;
            const data = await res.json();
            const list = data.content || [];
            // remove current
            const filtered = list.filter(x => x.id !== excludeId);
            renderRelated(filtered);
        } catch (e) { console.error('loadRelated', e); }
    }

    function renderRelated(list){
        relatedGrid.innerHTML = '';
        if (!list || list.length === 0) {
            relatedGrid.innerHTML = '<div class="small">Không có sản phẩm liên quan.</div>';
            return;
        }
        list.forEach(p => {
            const card = document.createElement('div');
            card.style.background = '#fff';
            card.style.padding = '8px';
            card.style.borderRadius = '8px';
            card.style.cursor = 'pointer';
            card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.06)';
            card.onclick = () => location.href = `/product.html?id=${p.id}`;

            const thumbDiv = document.createElement('div');
            thumbDiv.style.height = '90px';
            thumbDiv.style.borderRadius = '6px';
            thumbDiv.style.backgroundSize = 'cover';
            thumbDiv.style.backgroundPosition = 'center';
            thumbDiv.style.marginBottom = '8px';
            if (p.imgUrl) thumbDiv.style.backgroundImage = `url('${p.imgUrl}')`;
            else thumbDiv.style.background = 'linear-gradient(90deg,#eef2ff,#e0f2fe)';

            const title = document.createElement('div');
            title.style.fontSize = '14px';
            title.style.fontWeight = '600';
            title.style.height = '36px';
            title.style.overflow = 'hidden';
            title.innerText = p.name || '';

            const v = (p.variants && p.variants[0]) ? p.variants[0] : null;
            const price = document.createElement('div');
            price.style.marginTop = '6px';
            price.style.color = '#059669';
            price.style.fontWeight = '700';
            price.innerText = v ? (v.price.toLocaleString() + 'đ') : 'Liên hệ';

            card.appendChild(thumbDiv);
            card.appendChild(title);
            card.appendChild(price);
            relatedGrid.appendChild(card);
        });
    }

    /* ------------- nav category clicks (simple client-side map) ------------- */
    document.querySelectorAll('.nav-inner span').forEach(span=>{
        span.addEventListener('click', ()=>{
            // simple mapping - change to your real category IDs or call /api/categories to map
            const key = span.dataset.cat;
            // quick mapping (adjust IDs to your DB)
            const map = {
                'giaitri': 1,
                'lamviec': 2,
                'hoctap': 3,
                'windows': 4,
                'vpn': 5
            };
            const cid = map[key] || null;
            if (cid) {
                // go to homepage and filter by category param (homepage should support it)
                window.location.href = `/homepage.html?categoryId=${cid}`;
            } else {
                // fallback: just go homepage
                window.location.href = '/homepage.html';
            }
        });
    });
    /* ---------- Review (rating + comment) ---------- */
    const stars = document.querySelectorAll('#ratingStars .star');
    let selectedStars = 0;
    const reviewComment = document.getElementById('reviewComment');
    const submitReview = document.getElementById('submitReview');
    const reviewsList = document.getElementById('reviewsList');

    // click chọn sao
    stars.forEach(star=>{
        star.addEventListener('click', ()=>{
            selectedStars = parseInt(star.dataset.val);
            renderStars();
        });
    });
    function renderStars(){
        stars.forEach(s=>{
            if (parseInt(s.dataset.val) <= selectedStars) s.textContent = '★';
            else s.textContent = '☆';
        });
    }

    // load review từ localStorage
    function loadReviews(pid){
        try{
            const all = JSON.parse(localStorage.getItem('reviews')||'{}');
            return all[pid]||[];
        }catch(e){return []}
    }
    function saveReview(pid, review){
        const all = JSON.parse(localStorage.getItem('reviews')||'{}');
        if(!all[pid]) all[pid]=[];
        all[pid].push(review);
        localStorage.setItem('reviews', JSON.stringify(all));
    }

    // render reviews UI
    function renderReviews(pid){
        const list = loadReviews(pid);
        reviewsList.innerHTML = '';
        if(list.length===0){
            reviewsList.innerHTML = '<div class="small">Chưa có đánh giá nào.</div>';
            return;
        }
        list.forEach(r=>{
            const div = document.createElement('div');
            div.style.background = '#fff';
            div.style.padding = '10px';
            div.style.borderRadius = '6px';
            div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.06)';
            div.innerHTML = `
            <div style="color:gold;font-size:16px">${'★'.repeat(r.stars)}${'☆'.repeat(5-r.stars)}</div>
            <div style="margin-top:4px">${escapeHtml(r.comment||'')}</div>
            <div class="small" style="color:#666;margin-top:4px">${r.date}</div>
        `;
            reviewsList.appendChild(div);
        });
    }

    // submit
    submitReview.addEventListener('click', ()=>{
        if(!productId){alert('Không có sản phẩm!');return;}
        if(selectedStars===0){alert('Vui lòng chọn số sao');return;}
        const cmt = reviewComment.value.trim();
        if(!cmt){alert('Vui lòng nhập nhận xét');return;}

        const review = {
            stars: selectedStars,
            comment: cmt,
            date: new Date().toLocaleString()
        };
        saveReview(productId, review);
        reviewComment.value = '';
        selectedStars = 0;
        renderStars();
        renderReviews(productId);
    });

    // khi tải xong product => hiển thị review
    if(productId){
        renderReviews(productId);
    }

</script>
</body>
</html>
