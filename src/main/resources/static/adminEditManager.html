<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Ch·ªânh s·ª≠a Manager - Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .profile-container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            width: 450px;
        }
        .profile-container h2 {
            text-align: center;
            color: #1976d2;
            margin-bottom: 20px;
        }
        .avatar-section {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .avatar-img, .avatar-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid #1976d2;
        }
        .avatar-circle {
            background: #1976d2;
            color: white;
            font-size: 36px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            align-items: center;
        }
        .info-row span.label {
            font-weight: bold;
            color: #333;
            width: 120px;
        }
        input, select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .button-group {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
        }
        button {
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background 0.3s;
        }
        .save-btn { background: #1976d2; }
        .save-btn:hover { background: #1259a6; }
        .save-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-btn { background: #e53935; }
        .cancel-btn:hover { background: #c62828; }
        /* Th√™m v√†o ph·∫ßn style hi·ªán c√≥ */
        .field-message {
            color: red;
            font-size: 12px;
            margin-top: 4px;
            font-style: italic;
        }

        input.error {
            border-color: red !important;
        }

        input.success {
            border-color: green !important;
        }

        .info-row {
            position: relative;
            margin-bottom: 16px; /* TƒÉng margin ƒë·ªÉ ch·ª©a message */
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="profile-container">
    <h2>üë®‚Äçüíº Ch·ªânh s·ª≠a th√¥ng tin Manager</h2>

    <!-- Avatar Section -->
    <div class="avatar-section">
        <img id="avatarPreview" class="avatar-img" src="" alt="Avatar" style="display:none;">
        <div id="avatarCircle" class="avatar-circle" style="display:none;"></div>
        <input type="file" id="avatar" name="avatar" accept="image/*" style="display:none;">
    </div>

    <!-- Information Form -->
    <div class="info-row">
        <span class="label">H·ªç t√™n:</span>
        <input type="text" id="name" placeholder="Nh·∫≠p h·ªç t√™n">
    </div>
    <div class="info-row">
        <span class="label">Username:</span>
        <input type="text" id="username" placeholder="Nh·∫≠p username">
    </div>
    <div class="info-row">
        <span class="label">Email:</span>
        <input type="email" id="email" placeholder="Nh·∫≠p email">
    </div>
    <div class="info-row">
        <span class="label">S·ªë ƒëi·ªán tho·∫°i:</span>
        <input type="tel" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
    </div>
    <div class="info-row">
        <span class="label">Tr·∫°ng th√°i:</span>
        <select id="status">
            <option value="ACTIVE">ACTIVE</option>
            <option value="BANNED">BANNED</option>
        </select>
    </div>

    <!-- Action Buttons -->
    <div class="button-group">
        <button class="save-btn" id="saveBtn">üíæ L∆∞u thay ƒë·ªïi</button>
        <button class="cancel-btn" id="cancelBtn">H·ªßy b·ªè</button>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080/api/admin/managers";
    const params = new URLSearchParams(window.location.search);
    const managerId = params.get("id");
    let managerData = {};
    let isLoading = false;

    // üü¶ Load d·ªØ li·ªáu Manager
    async function loadManager() {
        try {
            showLoading(true);
            const res = await fetch(`${API_URL}/${managerId}`);

            if (!res.ok) {
                throw new Error("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Manager!");
            }

            const data = await res.json();
            managerData = data;

            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            document.getElementById("name").value = data.name || "";
            document.getElementById("username").value = data.username || "";
            document.getElementById("email").value = data.email || "";
            document.getElementById("phone").value = data.phone || "";
            document.getElementById("status").value = data.status || "ACTIVE";

            // Hi·ªÉn th·ªã avatar
            displayAvatar(data);

        } catch (err) {
            showNotification("‚ùå " + err.message, "error");
            console.error(err);
        } finally {
            showLoading(false);
        }
    }

    // üü¶ Hi·ªÉn th·ªã avatar
    function displayAvatar(data) {
        const avatarPreview = document.getElementById("avatarPreview");
        const avatarCircle = document.getElementById("avatarCircle");

        if (data.avatar && data.avatar.length > 0) {
            // Convert byte array to base64
            const base64 = btoa(new Uint8Array(data.avatar).reduce(
                (data, byte) => data + String.fromCharCode(byte), ''
            ));
            avatarPreview.src = `data:image/jpeg;base64,${base64}`;
            avatarPreview.style.display = "block";
            avatarCircle.style.display = "none";
        } else {
            const firstLetter = (data.username || "M")[0].toUpperCase();
            avatarCircle.innerText = firstLetter;
            avatarCircle.style.display = "flex";
            avatarPreview.style.display = "none";
        }
    }

    // üü¢ C·∫≠p nh·∫≠t th√¥ng tin Manager (ƒê√É S·ª¨A)
    async function saveProfile(file = null) {
        if (isLoading) return;

        // Validate form tr∆∞·ªõc khi g·ª≠i
        if (!validateForm()) {
            return;
        }

        try {
            isLoading = true;
            showLoading(true);

            const formData = new FormData();
            formData.append("name", document.getElementById("name").value.trim());
            formData.append("username", document.getElementById("username").value.trim());
            formData.append("email", document.getElementById("email").value.trim());
            formData.append("phone", document.getElementById("phone").value.trim());
            formData.append("status", document.getElementById("status").value);

            if (file) {
                formData.append("avatar", file);
            }

            const res = await fetch(`${API_URL}/${managerId}/form`, {
                method: "PUT",
                body: formData
            });

            const result = await res.json();

            if (!res.ok) {
                // X·ª≠ l√Ω c√°c l·ªói c·ª• th·ªÉ t·ª´ backend
                if (result.error === "EMAIL_EXISTS") {
                    showNotification("‚ùå Email ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng! Vui l√≤ng s·ª≠ d·ª•ng email kh√°c.", "error");
                    document.getElementById("email").style.borderColor = "red";
                    return;
                } else if (result.error === "USERNAME_EXISTS") {
                    showNotification("‚ùå Username ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng! Vui l√≤ng ch·ªçn username kh√°c.", "error");
                    document.getElementById("username").style.borderColor = "red";
                    return;
                } else if (result.error === "INVALID_EMAIL") {
                    showNotification("‚ùå Email kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.", "error");
                    document.getElementById("email").style.borderColor = "red";
                    return;
                } else if (result.error === "INVALID_PHONE") {
                    showNotification("‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Ph·∫£i c√≥ 10-11 ch·ªØ s·ªë.", "error");
                    document.getElementById("phone").style.borderColor = "red";
                    return;
                } else {
                    showNotification("‚ùå L·ªói khi c·∫≠p nh·∫≠t: " + (result.message || "C√≥ l·ªói x·∫£y ra"), "error");
                    return;
                }
            }

            showNotification("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
            setTimeout(() => {
                window.location.href = "adminManagerController.html";
            }, 1500);

        } catch (err) {
            showNotification("‚ùå L·ªói k·∫øt n·ªëi: " + err.message, "error");
        } finally {
            isLoading = false;
            showLoading(false);
        }
    }

    // üü° Validate form tr∆∞·ªõc khi g·ª≠i
    function validateForm() {
        const email = document.getElementById("email").value.trim();
        const username = document.getElementById("username").value.trim();
        const phone = document.getElementById("phone").value.trim();
        let isValid = true;

        // Reset border colors
        document.getElementById("email").style.borderColor = "";
        document.getElementById("username").style.borderColor = "";
        document.getElementById("phone").style.borderColor = "";

        // Validate email
        if (email && !isValidEmail(email)) {
            showNotification("‚ùå Email kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p email ƒë√∫ng ƒë·ªãnh d·∫°ng.", "error");
            document.getElementById("email").style.borderColor = "red";
            isValid = false;
        }

        // Validate phone
        if (phone && !isValidPhone(phone)) {
            showNotification("‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! Ph·∫£i c√≥ 10-11 ch·ªØ s·ªë.", "error");
            document.getElementById("phone").style.borderColor = "red";
            isValid = false;
        }

        // Validate required fields
        if (!username) {
            showNotification("‚ùå Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "error");
            document.getElementById("username").style.borderColor = "red";
            isValid = false;
        }

        if (!email) {
            showNotification("‚ùå Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "error");
            document.getElementById("email").style.borderColor = "red";
            isValid = false;
        }

        return isValid;
    }

    // üü£ Real-time validation cho email v√† username
    function setupRealTimeValidation() {
        // Real-time email validation
        document.getElementById("email").addEventListener("blur", function() {
            const email = this.value.trim();
            if (email && email !== managerData.email) {
                if (!isValidEmail(email)) {
                    this.style.borderColor = "red";
                    showFieldMessage(this, "Email kh√¥ng h·ª£p l·ªá");
                } else {
                    this.style.borderColor = "green";
                    hideFieldMessage(this);
                    // Ki·ªÉm tra email tr√πng (c√≥ th·ªÉ g·ªçi API n·∫øu c·∫ßn)
                }
            }
        });

        // Real-time username validation
        document.getElementById("username").addEventListener("blur", function() {
            const username = this.value.trim();
            if (username && username !== managerData.username) {
                if (username.length < 3) {
                    this.style.borderColor = "red";
                    showFieldMessage(this, "Username ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±");
                } else {
                    this.style.borderColor = "green";
                    hideFieldMessage(this);
                    // Ki·ªÉm tra username tr√πng (c√≥ th·ªÉ g·ªçi API n·∫øu c·∫ßn)
                }
            }
        });

        // Real-time phone validation
        document.getElementById("phone").addEventListener("blur", function() {
            const phone = this.value.trim();
            if (phone && phone !== managerData.phone) {
                if (!isValidPhone(phone)) {
                    this.style.borderColor = "red";
                    showFieldMessage(this, "S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë");
                } else {
                    this.style.borderColor = "green";
                    hideFieldMessage(this);
                }
            }
        });

        // Reset validation khi ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu nh·∫≠p
        document.getElementById("email").addEventListener("input", function() {
            this.style.borderColor = "";
            hideFieldMessage(this);
        });

        document.getElementById("username").addEventListener("input", function() {
            this.style.borderColor = "";
            hideFieldMessage(this);
        });

        document.getElementById("phone").addEventListener("input", function() {
            this.style.borderColor = "";
            hideFieldMessage(this);
        });
    }

    // üü¢ Utility functions
    function isValidEmail(email) {
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
    }

    function isValidPhone(phone) {
        const phoneRegex = /^[0-9]{10,11}$/;
        return phoneRegex.test(phone);
    }

    function showFieldMessage(inputElement, message) {
        let messageElement = inputElement.parentNode.querySelector('.field-message');
        if (!messageElement) {
            messageElement = document.createElement('div');
            messageElement.className = 'field-message';
            messageElement.style.cssText = `
                color: red;
                font-size: 12px;
                margin-top: 4px;
            `;
            inputElement.parentNode.appendChild(messageElement);
        }
        messageElement.textContent = message;
    }

    function hideFieldMessage(inputElement) {
        const messageElement = inputElement.parentNode.querySelector('.field-message');
        if (messageElement) {
            messageElement.remove();
        }
    }

    function showLoading(loading) {
        const container = document.querySelector('.profile-container');
        const saveBtn = document.getElementById('saveBtn');

        if (loading) {
            container.classList.add('loading');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';
        } else {
            container.classList.remove('loading');
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'üíæ L∆∞u thay ƒë·ªïi';
        }
    }

    function showNotification(message, type) {
        // Remove existing notification
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            background: ${type === 'success' ? '#43a047' : '#e53935'};
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 4000);
    }

    // üü£ X·ª≠ l√Ω ch·ªçn avatar
    function setupAvatarHandlers() {
        document.getElementById("avatarPreview").addEventListener("click", () => {
            document.getElementById("avatar").click();
        });

        document.getElementById("avatarCircle").addEventListener("click", () => {
            document.getElementById("avatar").click();
        });

        document.getElementById("avatar").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                showNotification("‚ùå Vui l√≤ng ch·ªçn file ·∫£nh!", "error");
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showNotification("‚ùå File ·∫£nh qu√° l·ªõn (t·ªëi ƒëa 5MB)!", "error");
                return;
            }

            // Preview image
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById("avatarPreview").src = e.target.result;
                document.getElementById("avatarPreview").style.display = "block";
                document.getElementById("avatarCircle").style.display = "none";
            };
            reader.readAsDataURL(file);

            // Upload immediately
            await saveProfile(file);
        });
    }

    // üü° Event Listeners
    document.getElementById("saveBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        await saveProfile();
    });

    document.getElementById("cancelBtn").addEventListener("click", () => {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy thay ƒë·ªïi kh√¥ng? M·ªçi thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.")) {
            window.location.href = "adminManagerController.html";
        }
    });

    // Kh·ªüi ƒë·ªông
    setupAvatarHandlers();
    setupRealTimeValidation();
    loadManager();
</script>
</body>
</html>