<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>
<div class="profile-container">
    <a href="homepage.html" class="back-home">Back to Home</a>
    <h2>Thông tin cá nhân</h2>

    <div class="avatar-section">
        <img id="avatarPreview" src="default-avatar.png" alt="Avatar">
        <input type="file" id="avatarInput" name="avatar" hidden>
    </div>

    <form id="profileForm">
        <div class="field-section">
            <label>Họ tên:</label>
            <span id="nameDisplay"></span>
            <input type="text" id="nameInput" name="name" hidden>
        </div>

        <div class="field-section">
            <label>Email:</label>
            <span id="emailDisplay"></span>
            <input type="email" id="emailInput" name="email" hidden>
        </div>

        <div class="field-section">
            <label>Ngày sinh:</label>
            <span id="dobDisplay"></span>
            <input type="date" id="dobInput" name="dob" hidden>
        </div>

        <div class="button-row">
            <button type="button" id="editInfoBtn">Edit thông tin</button>
            <button type="submit" id="saveBtn" hidden>Lưu thay đổi</button>
            <button type="button" id="cancelBtn" hidden>Hủy thay đổi</button>
        </div>
    </form>
</div>

<script>
    const customerId = sessionStorage.getItem("customerId");

    // Load dữ liệu từ DB
    fetch(`/api/customer/${customerId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("nameDisplay").innerText = data.name;
            document.getElementById("emailDisplay").innerText = data.email;
            document.getElementById("dobDisplay").innerText = data.dob || '';
            if(data.avatar) document.getElementById("avatarPreview").src = data.avatar;

            document.getElementById("nameInput").value = data.name;
            document.getElementById("emailInput").value = data.email;
            document.getElementById("dobInput").value = data.dob || '';
        });

    // Click avatar để đổi ảnh
    document.getElementById("avatarPreview").addEventListener("click", () => {
        document.getElementById("avatarInput").click();
    });

    document.getElementById("avatarInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if(file) document.getElementById("avatarPreview").src = URL.createObjectURL(file);
    });

    // Bật edit thông tin
    document.getElementById("editInfoBtn").addEventListener("click", () => {
        ["nameInput","emailInput","dobInput"].forEach(id => {
            document.getElementById(id).hidden = false;
            document.getElementById(id.replace("Input","Display")).hidden = true;
        });
        document.getElementById("saveBtn").hidden = false;
        document.getElementById("cancelBtn").hidden = false;
        document.getElementById("editInfoBtn").hidden = true;
    });

    // Nút hủy thay đổi -> reload lại profile
    document.getElementById("cancelBtn").addEventListener("click", () => {
        location.reload();
    });

    // Submit update
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append("name", document.getElementById("nameInput").value);
        formData.append("email", document.getElementById("emailInput").value);
        formData.append("dob", document.getElementById("dobInput").value);
        const avatarFile = document.getElementById("avatarInput").files[0];
        if(avatarFile) formData.append("avatar", avatarFile);

        const res = await fetch(`/api/customer/${customerId}/update`, {
            method: "POST",
            body: formData
        });

        if(res.ok){
            alert("Cập nhật thành công!");
            location.reload();
        } else alert("Cập nhật thất bại!");
    });
</script>
</body>
</html>
