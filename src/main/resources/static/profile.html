<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>
<div class="profile-container">
    <h2>Thông tin cá nhân</h2>

    <div class="avatar-section">
        <img id="avatarPreview" class="avatar-img" src="default-avatar.png" alt="Avatar" style="display:none;">
        <div id="avatarCircle" class="avatar-circle" style="display:none;"></div>
        <input type="file" id="avatar" name="avatar" style="display:none;">
    </div>

    <!-- View mode -->
    <div class="info-section" id="infoView">
        <div class="info-row">
            <span class="label">Họ tên:</span>
            <span id="nameText"></span>
        </div>
        <div class="info-row">
            <span class="label">Email:</span>
            <span id="emailText"></span>
        </div>
        <div class="info-row">
            <span class="label">Ngày sinh:</span>
            <span id="dobText"></span>
        </div>
    </div>

    <!-- Edit mode -->
    <div class="info-section" id="infoEdit" style="display:none;">
        <div class="info-row">
            <span class="label">Họ tên:</span>
            <input type="text" id="nameInput">
        </div>
        <div class="info-row">
            <span class="label">Email:</span>
            <input type="email" id="emailInput">
        </div>
        <div class="info-row">
            <span class="label">Ngày sinh:</span>
            <input type="date" id="dobInput">
        </div>
        <div class="button-group">
            <button class="save-btn" id="saveBtn">Save</button>
            <button class="cancel-btn" id="cancelBtn">Cancel</button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="edit-btn" id="editBtn">Edit</button>
        <button class="back-btn" onclick="window.location.href='homepage.html'">⬅ Back to Home</button>
    </div>
</div>

<script>
    const customerId = sessionStorage.getItem("customerId") || 1;
    let customerData = {};

    async function loadProfile() {
        try {
            const res = await fetch(`/api/customer/${customerId}`);
            if (!res.ok) throw new Error("Không lấy được dữ liệu");
            const data = await res.json();
            customerData = data;

            document.getElementById("nameText").innerText = data.name || "";
            document.getElementById("emailText").innerText = data.email || "";
            document.getElementById("dobText").innerText = data.dob || "";

            // Avatar: nếu có file ảnh thì hiển thị ảnh, nếu không thì hiển thị chữ cái đầu tiên
            if (data.avatar && (data.avatar.endsWith(".png") || data.avatar.endsWith(".jpg") || data.avatar.endsWith(".jpeg"))) {
                document.getElementById("avatarPreview").style.display = "block";
                document.getElementById("avatarPreview").src = "/" + data.avatar;
                document.getElementById("avatarCircle").style.display = "none";
            } else {
                document.getElementById("avatarCircle").style.display = "flex";
                document.getElementById("avatarCircle").innerText = data.avatar || (data.name ? data.name[0].toUpperCase() : "?");
                document.getElementById("avatarPreview").style.display = "none";
            }
        } catch (e) {
            console.error("Lỗi load profile:", e);
        }
    }
    loadProfile();

    // Edit
    document.getElementById("editBtn").addEventListener("click", () => {
        document.getElementById("infoView").style.display = "none";
        document.getElementById("infoEdit").style.display = "block";
        document.getElementById("editBtn").style.display = "none";

        document.getElementById("nameInput").value = customerData.name || "";
        document.getElementById("emailInput").value = customerData.email || "";
        document.getElementById("dobInput").value = customerData.dob || "";
    });

    // Cancel
    document.getElementById("cancelBtn").addEventListener("click", () => {
        document.getElementById("infoView").style.display = "block";
        document.getElementById("infoEdit").style.display = "none";
        document.getElementById("editBtn").style.display = "inline-block";
    });

    // Save
    document.getElementById("saveBtn").addEventListener("click", async () => {
        customerData.name = document.getElementById("nameInput").value;
        customerData.email = document.getElementById("emailInput").value;
        customerData.dob = document.getElementById("dobInput").value;

        await saveProfile();

        document.getElementById("infoView").style.display = "block";
        document.getElementById("infoEdit").style.display = "none";
        document.getElementById("editBtn").style.display = "inline-block";

        document.getElementById("nameText").innerText = customerData.name;
        document.getElementById("emailText").innerText = customerData.email;
        document.getElementById("dobText").innerText = customerData.dob;
    });

    // Avatar click (cả ảnh lẫn vòng tròn)
    document.getElementById("avatarPreview").addEventListener("click", () => {
        document.getElementById("avatar").click();
    });
    document.getElementById("avatarCircle").addEventListener("click", () => {
        document.getElementById("avatar").click();
    });

    document.getElementById("avatar").addEventListener("change", () => {
        const file = document.getElementById("avatar").files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById("avatarPreview").style.display = "block";
                document.getElementById("avatarPreview").src = e.target.result;
                document.getElementById("avatarCircle").style.display = "none";
            };
            reader.readAsDataURL(file);
            saveProfile(file);
        }
    });

    // API update
    async function saveProfile(file) {
        try {
            const formData = new FormData();
            formData.append("name", customerData.name || "");
            formData.append("email", customerData.email || "");
            formData.append("dob", customerData.dob || "");
            if (file) {
                formData.append("avatar", file);
            }

            const res = await fetch(`/api/customer/${customerId}/update`, {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                const updated = await res.json();
                customerData = updated; // cập nhật lại dữ liệu mới từ server
                console.log("Cập nhật thành công!");
            } else {
                const errorText = await res.text();
                console.error("Lỗi cập nhật:", errorText);
            }
        } catch (e) {
            console.error("Exception khi update:", e);
        }
    }
</script>
</body>
</html>
